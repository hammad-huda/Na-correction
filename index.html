<script>
  function calcTBW(sex, weightKg) {
    const factor = (sex === "male") ? 0.6 : 0.5;
    return factor * weightKg; // liters
  }

  function naIVF(type) {
    if (type === "D5W") return 0;
    if (type === "0.45NS") return 77;   // change to 75 if you want; keep label consistent
    if (type === "0.9NS") return 154;
    if (type === "2NS") return 342;
    if (type === "3NS") return 513;
    throw new Error("Unknown IVF type");
  }

  function fmt(n, digits=2) {
    return Number.isFinite(n) ? n.toFixed(digits) : String(n);
  }

  function correctedNaForGlucose(naMeasured, glucose, factor, baseline=100) {
    if (!Number.isFinite(glucose)) {
      return { naCorrected: naMeasured, applied: false, deltaGlc: 0, correction: 0, baseline };
    }
    const base = Number.isFinite(baseline) ? baseline : 100;
    const deltaGlc = Math.max(0, glucose - base);
    const correction = factor * (deltaGlc / 100);
    return { naCorrected: naMeasured + correction, applied: true, deltaGlc, correction, baseline: base };
  }

  document.getElementById("calc").addEventListener("click", () => {
    const sex = document.getElementById("sex").value;
    const wt = parseFloat(document.getElementById("wt").value);

    const naMeasured = parseFloat(document.getElementById("naCur").value);
    const naGoal = parseFloat(document.getElementById("naGoal").value);

    const glc = parseFloat(document.getElementById("glc").value);
    const glcBase = parseFloat(document.getElementById("glcBase").value);
    const naCorrFactor = parseFloat(document.getElementById("naCorrFactor").value);

    const ivf = document.getElementById("ivf").value;

    const out = document.getElementById("out");
    out.style.display = "block";

    // Basic validation
    if (![wt, naMeasured, naGoal].every(Number.isFinite)) {
      out.innerHTML = `<div class="warn">Please enter weight, current Na, and goal Na.</div>`;
      return;
    }
    if (wt <= 0) {
      out.innerHTML = `<div class="warn">Weight must be > 0.</div>`;
      return;
    }

    const TBW = calcTBW(sex, wt);
    const NaInf = naIVF(ivf);

    // Hyperglycemia correction (optional)
    const corr = correctedNaForGlucose(
      naMeasured,
      glc,
      Number.isFinite(naCorrFactor) ? naCorrFactor : 1.6,
      Number.isFinite(glcBase) ? glcBase : 100
    );
    const naCurEffective = corr.naCorrected; // use corrected Na in the mixing model

    // x = TBW*(Na_goal - Na_current) / (Na_IVF - Na_goal)
    const denom = (NaInf - naGoal);

    if (denom === 0) {
      out.innerHTML = `<div class="warn">Na<sub>IVF</sub> equals goal Na — cannot solve (division by zero).</div>`;
      return;
    }

    const xLiters = TBW * (naGoal - naCurEffective) / denom;
    const x_mL = xLiters * 1000;
    const rate_mL_per_hr = x_mL / 24;

    let warning = "";
    if (xLiters < 0) {
      warning = `<div class="warn">Result is negative — this fluid cannot move Na toward the selected goal (check fluid choice/goal direction).</div>`;
    }

    const naLine = corr.applied
      ? `<p><b>Na (measured)</b> = ${naMeasured} mEq/L</p>
         <p><b>Corrected Na</b> = <b>${fmt(naCurEffective,2)} mEq/L</b>
           <br/><span class="muted">ΔGlucose = ${fmt(corr.deltaGlc,0)} mg/dL; correction = ${fmt(corr.correction,2)} mEq/L (factor ${fmt(naCorrFactor,1)}, baseline ${fmt(corr.baseline,0)})</span>
         </p>`
      : `<p><b>Na (current)</b> = ${naMeasured} mEq/L <span class="muted">(no glucose entered)</span></p>`;

    out.innerHTML = `
      ${warning}
      <h2>Results</h2>
      <p><b>TBW</b> = ${sex === "male" ? "0.6" : "0.5"} × ${wt} = <b>${fmt(TBW,2)} L</b></p>
      ${naLine}
      <p><b>Na<sub>IVF</sub></b> = <b>${NaInf} mEq/L</b></p>

      <h3>Equation (showing work)</h3>
      <div class="mono">
        x = TBW × (Na_goal − Na_current) / (Na_IVF − Na_goal)
        <br/>
        x = ${fmt(TBW,2)} × (${naGoal} − ${fmt(naCurEffective,2)}) / (${NaInf} − ${naGoal})
        <br/>
        x = <b>${fmt(xLiters,3)} L</b> = <b>${fmt(x_mL,0)} mL</b>
        <br/>
        Rate over 24h = <b>${fmt(rate_mL_per_hr,1)} mL/hr</b>
      </div>
    `;
  });
</script>
